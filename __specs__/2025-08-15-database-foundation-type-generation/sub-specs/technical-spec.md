# Technical Specification

This is the technical specification for the spec detailed in
@**specs**/2025-08-15-database-foundation-type-generation/spec.md

## Critical Implementation Details

### File Structure & Location Requirements

**Migration Files Location:**

- Path: `supabase/migrations/`
- Naming: `NNNN_description.sql` (ascending integers: 0001*, 0002*, 0003\_)
- Content: Pure SQL only - no application code or external dependencies
- Authority: These files are the ONLY source of truth for database schema

**Type Generation Output:**

- Primary Output: `packages/types/supabase.ts` (generated, never edit manually)
- Generation Script: `scripts/typegen-supabase.mjs`
- Package.json Script: `"typegen:supabase": "node scripts/typegen-supabase.mjs"`

**Supabase Configuration:**

- Config File: `supabase/config.toml` (auto-generated by CLI)
- Local Settings: `supabase/.env.local` (git-ignored, contains local project refs)
- Seed Data: `supabase/seed/seed.sql` (development only, idempotent)

### Integration with Existing Project Architecture

**Next.js Integration Points:**

- Client Library: Use in `apps/web/lib/supabase/client.ts` (browser client with anon key)
- Server Library: Use in `apps/web/lib/supabase/server.ts` (server client with service role)
- Type Imports: `import { Database } from '@repo/types/supabase'` in all DB-related files
- Environment Variables: Store in Vercel for web app (NEXT_PUBLIC_SUPABASE_URL, etc.)

**Monorepo Package Integration:**

- Types Package: Generated types consumed by `apps/web/` and future `services/`
- Workspace Reference: `packages/types` added to web app's package.json dependencies
- Import Path: Use workspace aliases like `@repo/types/supabase` for clean imports

### Authentication System Foundation (Phase 4 Preparation)

**Profiles Table Design:**

```sql
-- Must extend auth.users table, not replace it
CREATE TABLE public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    email TEXT NOT NULL, -- Synced from auth.users
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Auth Integration Requirements:**

- Supabase Auth manages authentication (signup, login, sessions)
- Public.profiles table stores application-specific user data
- RLS policies use `auth.uid()` function for user identification
- Email verification enabled by default in Supabase Auth settings

**Future Auth UI Integration:**

- `@supabase/auth-ui-react` will consume these profile records
- Session management through Supabase client automatically links to public.profiles
- Email/password + magic link flows supported out of the box

### Payment System Foundation (Phase 6 Preparation)

**Subscription Table Design:**

```sql
-- Designed for Lemon Squeezy webhook integration
CREATE TABLE public.subscriptions (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    status TEXT NOT NULL CHECK (status IN ('trial', 'active', 'cancelled', 'expired')),
    plan TEXT NOT NULL CHECK (plan IN ('free', 'basic', 'pro')),
    lemon_squeezy_id TEXT, -- External payment provider ID
    current_period_start TIMESTAMPTZ,
    current_period_end TIMESTAMPTZ,
    trial_ends_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id) -- One subscription per user
);
```

**Payment Webhook Preparation:**

- Webhook handler in `apps/web/app/api/webhooks/lemonsqueezy/route.ts` will update this table
- Service role client required for webhook operations (bypasses RLS)
- Usage counters table ready for quota enforcement

### Email System Foundation (Phase 5 Preparation)

**User Email Integration:**

- Email addresses stored in both `auth.users` and `public.users` (synced)
- Resend integration will use public.users.email for application emails
- Supabase Auth handles transactional emails (signup confirmation, password reset)
- Application emails (notifications, marketing) use Resend

### Storage Implementation Details

**Bucket Configuration:**

```sql
-- Storage bucket for user files
INSERT INTO storage.buckets (id, name, public)
VALUES ('user-files', 'user-files', false);
```

**Path Convention Standard:**

- Format: `{userId}/{entity}/{yyyy}/{mm}/{uuid}.{ext}`
- Example:
  `550e8400-e29b-41d4-a716-446655440000/profile/2025/08/550e8400-e29b-41d4-a716-446655440001.jpg`
- Benefits: User isolation, chronological organization, UUID prevents conflicts

**Storage Security Model:**

- RLS policies on `storage.objects` table ensure user isolation
- Client uploads limited to user's own folder via `auth.uid()` check
- Signed URLs for secure file access (temporary, time-limited)
- Content-Type validation at upload time

### Database Connection & Performance

**Connection Configuration:**

- Development: Direct connection via Supabase CLI (`supabase start`)
- Production: Connection pooling handled automatically by Supabase
- Connection String Format: `postgresql://[user]:[pass]@[host]:5432/postgres`

**Performance Optimizations:**

- Primary key indexes on all tables (automatic)
- Foreign key indexes for join optimization
- Selective indexing on frequently queried columns (user_id, status, window_start)
- RLS policies optimized to use indexed columns

### Type Generation Technical Details

**Generation Process:**

1. Supabase CLI introspects live database schema
2. Generates TypeScript interfaces for tables, views, functions
3. Creates union types for enums and constraints
4. Outputs complete Database interface with typed operations

**Generated Type Structure:**

```typescript
export interface Database {
  public: {
    Tables: {
      profiles: {
        Row: { id: string; email: string; created_at: string; updated_at: string }
        Insert: { id: string; email: string; created_at?: string; updated_at?: string }
        Update: { id?: string; email?: string; created_at?: string; updated_at?: string }
      }
      // ... other tables
    }
    Views: {
      /* generated views */
    }
    Functions: {
      /* generated functions */
    }
  }
}
```

**Type Usage in Application:**

```typescript
import { createClient } from '@supabase/supabase-js'
import { Database } from '@repo/types/supabase'

const supabase = createClient<Database>(url, key)
// Now all queries are fully typed
```

### Environment Configuration

**Development Environment Variables:**

```bash
# Local development (supabase/.env.local)
SUPABASE_PROJECT_ID=your-dev-project-id
SUPABASE_DB_PASSWORD=your-dev-password

# Next.js app (apps/web/.env.local)
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

**Production Environment Variables:**

```bash
# Vercel environment (production)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-prod-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-prod-service-role-key
```

### Security Implementation Requirements

**Row Level Security (RLS) Policies:**

- Enable RLS on ALL public tables
- Client-side access only through anon key + RLS policies
- Service role access for server-side operations (webhooks, background jobs)
- User isolation enforced at database level, not application level

**Critical Security Rules:**

- Never expose service role key to client-side code
- All user data access goes through RLS policies
- Storage bucket access controlled by RLS on storage.objects
- Authentication state managed exclusively by Supabase Auth

### Package Dependencies & Workspace Setup

**Root Package.json Scripts to Add:**

```json
{
  "scripts": {
    "typegen:supabase": "node scripts/typegen-supabase.mjs",
    "db:start": "cd supabase && supabase start",
    "db:stop": "cd supabase && supabase stop",
    "db:reset": "cd supabase && supabase db reset",
    "db:migrate": "cd supabase && supabase db push"
  }
}
```

**Web App Package.json Dependencies to Add:**

```json
{
  "dependencies": {
    "@supabase/supabase-js": "^2.39.0",
    "@supabase/ssr": "^0.3.0"
  },
  "devDependencies": {
    "@supabase/auth-ui-react": "^0.4.0",
    "@supabase/auth-ui-shared": "^0.1.0"
  }
}
```

**Types Package Structure to Create:**

```
packages/types/
├── package.json
├── tsconfig.json
├── src/
│   ├── index.ts
│   └── supabase.ts (generated - never edit)
└── README.md
```

**Types Package.json Content:**

```json
{
  "name": "@repo/types",
  "version": "0.1.0",
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": "./src/index.ts",
    "./supabase": "./src/supabase.ts"
  },
  "scripts": {
    "type-check": "tsc --noEmit"
  },
  "devDependencies": {
    "typescript": "^5.7.0"
  }
}
```

### Critical File Creation Requirements

**Supabase Client Files to Create:**

1. **apps/web/lib/supabase/client.ts** - Browser client

```typescript
import { createBrowserClient } from '@supabase/ssr'
import { Database } from '@repo/types/supabase'

export const createClient = () =>
  createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
```

2. **apps/web/lib/supabase/server.ts** - Server client

```typescript
import { createServerClient } from '@supabase/ssr'
import { Database } from '@repo/types/supabase'
import { cookies } from 'next/headers'

export const createClient = () => {
  const cookieStore = cookies()

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
      },
    }
  )
}

export const createServiceClient = () =>
  createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      cookies: {},
    }
  )
```

**Type Generation Script to Create:**

**scripts/typegen-supabase.mjs**

```javascript
#!/usr/bin/env node
import { execSync } from 'child_process'
import { writeFileSync, readFileSync } from 'fs'
import { fileURLToPath } from 'url'
import { dirname, join } from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const projectRoot = join(__dirname, '..')

try {
  console.log('🔄 Generating Supabase types...')

  // Generate types from local Supabase instance
  const command = 'supabase gen types typescript --local --schema public'
  const output = execSync(command, {
    cwd: join(projectRoot, 'supabase'),
    encoding: 'utf8',
  })

  // Write to packages/types/src/supabase.ts
  const typesPath = join(projectRoot, 'packages/types/src/supabase.ts')
  writeFileSync(typesPath, output)

  console.log('✅ Supabase types generated successfully')
  console.log(`📁 Written to: ${typesPath}`)
} catch (error) {
  console.error('❌ Failed to generate Supabase types:', error.message)
  process.exit(1)
}
```

### Environment File Structure

**Files to Create:**

1. **supabase/.env.local** (git-ignored)

```bash
# Local Supabase development settings
SUPABASE_PROJECT_ID=your-local-project-id
SUPABASE_DB_PASSWORD=your-local-password
```

2. **apps/web/.env.local** (git-ignored)

```bash
# Local development environment
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-local-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-local-service-role-key
```

3. **apps/web/.env.example** (committed)

```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

**.gitignore additions:**

```
# Supabase
supabase/.env.local
supabase/.temp
supabase/logs

# Environment files
apps/web/.env.local
```

### Integration Testing Requirements

**Test Files to Create:**

1. **apps/web/tests/lib/supabase.test.ts** - Client integration tests
2. **apps/web/tests/db/schema.test.ts** - Schema validation tests
3. **apps/web/tests/db/rls.test.ts** - RLS policy tests
4. **apps/web/tests/types/generation.test.ts** - Type generation validation

## External Dependencies

**Core Dependencies:**

- **@supabase/supabase-js** (v2.39+) - Client library for database and auth operations
- **@supabase/ssr** (v0.3+) - Next.js SSR support for Supabase
- **Supabase CLI** (v1.163+) - Command-line tool for project management and type generation

**Development Dependencies:**

- **@supabase/auth-ui-react** (v0.4+) - Pre-built auth UI components (dev only for Phase 4)
- **Node.js 22.x** - Required for CLI and type generation scripts
- **PostgreSQL knowledge** - For writing migration files and understanding RLS

**Infrastructure Dependencies:**

- **Supabase Cloud Account** - For hosting database and auth services
- **Vercel Account** - For environment variable management in production

**Justification:** Supabase provides the complete data layer infrastructure (database, auth,
storage) with built-in type generation and security features, eliminating the need for separate
database hosting, authentication services, custom type management, and complex security
implementations.
